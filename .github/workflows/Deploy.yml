name: Deploy

on:
  push:
    tags:
      - '*.*.*'  # Triggers on version tags like 1.0.0, 2.1.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: safeturned/api

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Invalid SemVer format: $VERSION"
          exit 1
        fi
        
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)
        PATCH=$(echo $VERSION | cut -d. -f3)
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "patch=$PATCH" >> $GITHUB_OUTPUT
        echo "full_version=$VERSION" >> $GITHUB_OUTPUT

    - name: Determine branch and environment
      id: branch
      run: |
        if [ "${{ github.ref }}" = "refs/heads/master" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
          echo "branch=master" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
          echo "branch=dev" >> $GITHUB_OUTPUT
          echo "environment=development" >> $GITHUB_OUTPUT
        else
          echo "branch=master" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code with submodules
      uses: actions/checkout@v6
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Force initialize submodule
      run: |
        echo "=== Force initializing FileChecker submodule ==="
        git submodule add --force https://github.com/Safeturned/FileChecker.git FileChecker || true
        git submodule update --init --recursive
        echo "=== Checking submodule status ==="
        git submodule status
        echo "=== FileChecker directory contents ==="
        ls -la FileChecker/
        echo "=== FileChecker/src directory contents ==="
        ls -la FileChecker/src/

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      env:
        DOTNET_NOLOGO: true
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
        DOTNET_CLI_TELEMETRY_OPTOUT: true
      with:
        dotnet-version: 9.*

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Aspire CLI
      run: dotnet tool install --global Aspire.Cli

    - name: Publish with Aspire
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        ASPIRE_PROJECT=$(find . -name "*.AppHost.csproj" -o -name "*AppHost*.csproj" | head -n 1)

        if [ -z "$ASPIRE_PROJECT" ]; then
          echo "ERROR: Unable to locate Aspire AppHost project"
          exit 1
        fi

        echo "Building container via Aspire prepare-env for AppHost: $ASPIRE_PROJECT"
        mkdir -p ./publish/aspire

        aspire do prepare-env \
          --project "$ASPIRE_PROJECT" \
          -c Release \
          -o ./publish/aspire

        # Resolve the Aspire-built image from env file and retag
        ENV_FILE=""
        if [ -f "publish/aspire/.env.Production" ]; then
          ENV_FILE="publish/aspire/.env.Production"
        elif [ -f "publish/aspire/.env" ]; then
          ENV_FILE="publish/aspire/.env"
        fi

        APP_IMAGE=""
        if [ -n "$ENV_FILE" ]; then
          APP_IMAGE=$(grep -E '^[A-Z0-9_]*APP_IMAGE=' "$ENV_FILE" | head -n1 | cut -d= -f2-)
          if [ -z "$APP_IMAGE" ]; then
            APP_IMAGE=$(grep -E '^[A-Z0-9_]*IMAGE=' "$ENV_FILE" | head -n1 | cut -d= -f2-)
          fi
        fi

        if [ -z "$APP_IMAGE" ]; then
          # Fallback: first local image
          APP_IMAGE=$(docker images --format '{{.Repository}}:{{.Tag}}' | head -n1)
        fi

        if [ -z "$APP_IMAGE" ] || ! docker image inspect "$APP_IMAGE" >/dev/null 2>&1; then
          echo "ERROR: No local image found from Aspire output"
          exit 1
        fi

        echo "Retagging Aspire-built image $APP_IMAGE to ghcr.io/safeturned/api:v${VERSION}"
        docker tag "$APP_IMAGE" "ghcr.io/safeturned/api:v${VERSION}"

    - name: Push Docker image
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BRANCH="${{ steps.branch.outputs.branch }}"

        echo "Pushing image ghcr.io/safeturned/api:v${VERSION}..."
        docker push "ghcr.io/safeturned/api:v${VERSION}"

        echo "Tagging and pushing branch tag..."
        docker tag "ghcr.io/safeturned/api:v${VERSION}" "ghcr.io/safeturned/api:${BRANCH}"
        docker push "ghcr.io/safeturned/api:${BRANCH}"

        echo "✅ Images pushed successfully"

    - name: Create deployment package
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BRANCH="${{ steps.branch.outputs.branch }}"
        ENVIRONMENT="${{ steps.branch.outputs.environment }}"
        
        mkdir -p ./deploy
        
        cp ./publish/aspire/docker-compose.yaml ./deploy/
        cp ./publish/aspire/.env ./deploy/ 2>/dev/null || true
        
        cat > ./deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        VERSION="$1"
        BRANCH="$2"
        ENVIRONMENT="$3"
        REGISTRY_USERNAME="$4"
        REGISTRY_PASSWORD="$5"

        if [ -z "$VERSION" ] || [ -z "$BRANCH" ] || [ -z "$ENVIRONMENT" ]; then
            echo "Usage: $0 <version> <branch> <environment> [registry_username] [registry_password]"
            exit 1
        fi
        echo "Deploying version: $VERSION, branch: $BRANCH, environment: $ENVIRONMENT"

        if grep -q "^SAFETURNED_API_IMAGE=" .env 2>/dev/null; then
            sed -i "s|^SAFETURNED_API_IMAGE=.*|SAFETURNED_API_IMAGE=ghcr.io/safeturned/api:v${VERSION}|" .env
        else
            echo "SAFETURNED_API_IMAGE=ghcr.io/safeturned/api:v${VERSION}" >> .env
        fi

        docker compose down || true

        if [ -n "$REGISTRY_USERNAME" ] && [ -n "$REGISTRY_PASSWORD" ]; then
            echo "Logging into registry ghcr.io..."
            echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin
        fi

        docker pull ghcr.io/safeturned/api:v${VERSION} || echo "Image pull failed, will build locally"
        docker compose up -d

        echo "Deployment completed successfully!"
        EOF
        
        chmod +x ./deploy/deploy.sh

    - name: Copy files to server
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./deploy/deploy.sh,./deploy/docker-compose.yaml"
        target: "/opt/safeturned"

    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting API deployment ==="
          cd /opt/safeturned/deploy
          chmod +x deploy.sh
          ./deploy.sh "${{ steps.version.outputs.version }}" "${{ steps.branch.outputs.branch }}" "${{ steps.branch.outputs.environment }}" "${{ github.repository_owner }}" "${{ secrets.GITHUB_TOKEN }}"
          echo "=== API deployment completed ==="

    #- name: Create Release
    #  if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    #  uses: actions/create-release@v1
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #  with:
    #    tag_name: v${{ github.run_number }}
    #    release_name: Release v${{ github.run_number }}
    #    body: |
    #      ## Changes
    #      - Built from commit: ${{ github.sha }}
    #
    #    draft: false
    #    prerelease: false
