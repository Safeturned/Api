name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
        env:
          DOTNET_NOLOGO: true
          DOTNET_CLI_TELEMETRY_OPTOUT: true

      - name: Install Aspire CLI
        run: curl -sSL https://aspire.dev/install.sh | bash

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Set environment variables
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          echo "APP_VERSION=build.${{ github.run_number }}.${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Deploy
        working-directory: src/Safeturned.AppHost
        run: aspire deploy -e Production
        env:
          DockerSSH__TargetHost: ${{ secrets.SERVER_HOST }}
          DockerSSH__SshUsername: ${{ secrets.SERVER_USER }}
          DockerSSH__SshPort: ${{ secrets.SSH_PORT }}
          DockerRegistry__RegistryUrl: ghcr.io
          DockerRegistry__RepositoryPrefix: ${{ env.OWNER_LC }}/safeturned
          DockerRegistry__RegistryUsername: ${{ github.actor }}
          DockerRegistry__RegistryPassword: ${{ secrets.GITHUB_TOKEN }}
          Deployment__RemoteDeployPath: /opt/safeturned
          IMAGE_TAG_SUFFIX: ${{ env.APP_VERSION }}
          Parameters__AppVersion: ${{ env.APP_VERSION }}
          Parameters__DatabasePassword: ${{ secrets.DATABASE_PASSWORD }}
          Parameters__RedisPassword: ${{ secrets.REDIS_PASSWORD }}
          Parameters__SafeturnedBotApiKey: ${{ secrets.SAFETURNED_BOT_API_KEY }}

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      packages: write
    strategy:
      matrix:
        package: [api, discordbot, migrations, web]
    steps:
      - name: Delete old images
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ matrix.package }}
          package-type: container
          min-versions-to-keep: 5
          delete-only-untagged-versions: true
