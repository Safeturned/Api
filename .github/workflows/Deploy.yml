name: Deploy

on:
  workflow_dispatch:

env:
  PROJECT_NAME: safeturned
  DOCKER_REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Set computed variables
      id: vars
      run: |
        VERSION="v${{ github.run_number }}"
        OWNER="${{ github.repository_owner }}"
        PROJECT="${{ env.PROJECT_NAME }}"
        DEPLOY_TAG="${PROJECT}-$(date +%Y%m%d%H%M%S)"

        if [ "${{ github.ref }}" = "refs/heads/master" ]; then
          BRANCH="master"
          ENVIRONMENT="production"
        elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
          BRANCH="dev"
          ENVIRONMENT="development"
        else
          BRANCH="master"
          ENVIRONMENT="production"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "deploy_tag=$DEPLOY_TAG" >> $GITHUB_OUTPUT
        echo "owner=$OWNER" >> $GITHUB_OUTPUT
        echo "project=$PROJECT" >> $GITHUB_OUTPUT

        echo "Version: $VERSION | Branch: $BRANCH | Environment: $ENVIRONMENT"

    - name: Checkout code with submodules
      uses: actions/checkout@v6
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Force initialize submodule
      run: |
        echo "=== Force initializing FileChecker submodule ==="
        git submodule add --force https://github.com/Safeturned/FileChecker.git FileChecker || true
        git submodule update --init --recursive
        echo "=== Checking submodule status ==="
        git submodule status
        echo "=== FileChecker directory contents ==="
        ls -la FileChecker/

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.x
      env:
        DOTNET_NOLOGO: true
        DOTNET_CLI_TELEMETRY_OPTOUT: true

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Aspire CLI
      run: dotnet tool install --global Aspire.Cli

    - name: Build containers with Aspire
      run: |
        PROJECT="${{ steps.vars.outputs.project }}"

        aspire do build -c Release

        echo "Built images:"
        docker images --format 'table {{.Repository}}\t{{.Tag}}\t{{.Size}}' | grep "$PROJECT" || docker images

    - name: Tag and push images
      run: |
        PROJECT="${{ steps.vars.outputs.project }}"
        OWNER="${{ steps.vars.outputs.owner }}"
        VERSION="${{ steps.vars.outputs.version }}"
        BRANCH="${{ steps.vars.outputs.branch }}"
        DEPLOY_TAG="${{ steps.vars.outputs.deploy_tag }}"
        REGISTRY="${{ env.DOCKER_REGISTRY }}"

        push_image() {
          local name=$1
          local source_tag=$2

          local source="${PROJECT}-${name}:${source_tag}"
          local target_base="${REGISTRY}/${OWNER}/${PROJECT}-${name}"

          echo "Pushing ${name}..."
          docker tag "$source" "${target_base}:${DEPLOY_TAG}"
          docker tag "$source" "${target_base}:${VERSION}"
          docker tag "$source" "${target_base}:${BRANCH}"
          docker tag "$source" "${target_base}:latest"

          docker push "${target_base}:${DEPLOY_TAG}"
          docker push "${target_base}:${VERSION}"
          docker push "${target_base}:${BRANCH}"
          docker push "${target_base}:latest"
        }

        push_image "api" "latest"
        push_image "discordbot" "latest"
        push_image "migrations" "latest"
        push_image "web" "latest"

        echo "All images pushed successfully"

    - name: Generate deployment files
      run: |
        PROJECT="${{ steps.vars.outputs.project }}"
        ASPIRE_PROJECT=$(find . -name "*.AppHost.csproj" | head -n 1)

        mkdir -p ./publish/aspire ./deploy

        aspire do publish-env --project "$ASPIRE_PROJECT" -c Release -o ./publish/aspire

        cp ./publish/aspire/docker-compose.yaml ./deploy/
        cp ./publish/aspire/.env ./deploy/ 2>/dev/null || true

    - name: Create deploy script
      run: |
        PROJECT="${{ steps.vars.outputs.project }}"

        cat > ./deploy/deploy.sh << EOF
        #!/bin/bash
        set -e

        PROJECT="$PROJECT"
        VERSION="\$1"
        BRANCH="\$2"
        ENVIRONMENT="\$3"
        REGISTRY_USER="\$4"
        REGISTRY_PASS="\$5"

        if [ -z "\$VERSION" ] || [ -z "\$BRANCH" ]; then
          echo "Usage: \$0 <version> <branch> <environment> [registry_user] [registry_pass]"
          exit 1
        fi

        echo "Deploying \$PROJECT version \$VERSION (\$ENVIRONMENT)"

        if [ -n "\$REGISTRY_USER" ] && [ -n "\$REGISTRY_PASS" ]; then
          echo "\$REGISTRY_PASS" | docker login ghcr.io -u "\$REGISTRY_USER" --password-stdin
        fi

        for service in api discordbot migrations web; do
          VAR_NAME="\$(echo \${PROJECT}_\${service}_IMAGE | tr '[:lower:]' '[:upper:]' | tr '-' '_')"
          IMAGE="ghcr.io/\${REGISTRY_USER}/\${PROJECT}-\${service}:\${VERSION}"

          if grep -q "^\${VAR_NAME}=" .env 2>/dev/null; then
            sed -i "s|^\${VAR_NAME}=.*|\${VAR_NAME}=\${IMAGE}|" .env
          else
            echo "\${VAR_NAME}=\${IMAGE}" >> .env
          fi

          echo "Pulling \$service..."
          docker pull "\$IMAGE" || echo "Warning: Failed to pull \$service"
        done

        docker compose down 2>/dev/null || true
        docker compose up -d

        echo "Deployment complete"
        EOF

        chmod +x ./deploy/deploy.sh

    - name: Copy to server
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./deploy/*"
        target: "/opt/${{ env.PROJECT_NAME }}"
        strip_components: 1

    - name: Deploy on server
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/${{ env.PROJECT_NAME }}/deploy
          ./deploy.sh "${{ steps.vars.outputs.version }}" "${{ steps.vars.outputs.branch }}" "${{ steps.vars.outputs.environment }}" "${{ github.repository_owner }}" "${{ secrets.GITHUB_TOKEN }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      packages: write
    strategy:
      matrix:
        package: [safeturned-api, safeturned-discordbot, safeturned-migrations, safeturned-web]
    steps:
      - name: Delete old images
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ matrix.package }}
          package-type: container
          min-versions-to-keep: 5
          delete-only-untagged-versions: true
